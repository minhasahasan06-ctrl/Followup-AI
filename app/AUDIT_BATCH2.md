# Python backend audit (Batch 2)

## Observed features
- FastAPI app configures CORS, registers extensive routers (appointments, chatbot, research, video/voice, habits, medication timelines, and multiple “production ready” AI surfaces), and uses a lifespan hook to create tables, check OpenAI BAA flags, and initialize/cleanup AI engines asynchronously at startup/shutdown.【F:app/main.py†L27-L219】
- AI engine manager lazily loads video/audio engines via executors, exposes per-request trend/alert engines, and centralizes cleanup through a guarded singleton to prevent duplicate initialization.【F:app/services/ai_engine_manager.py†L15-L179】
- Config module centralizes environment-driven settings (DB URL, AWS/Twilio/OpenAI credentials, CORS origins) and provides helpers for OpenAI client creation and BAA compliance checks.【F:app/config.py†L7-L76】
- Auth dependencies wrap OAuth2 bearer tokens, decode Cognito/DEV tokens, and enforce doctor/patient role-based access for routes such as chatbot and medication analysis; medication side-effects API applies request schemas and access checks per patient/doctor connection before running correlation analysis.【F:app/dependencies.py†L1-L73】【F:app/utils/security.py†L19-L150】【F:app/routers/chatbot.py†L1-L29】【F:app/routers/medication_side_effects.py†L1-L195】

## Gaps and risks
- Startup suppresses all warnings/logging globally and forces CPU mode, masking dependency/runtime issues and making observability difficult in production; BAA checks only print messages and do not block unsafe AI use when flags are false.【F:app/main.py†L4-L25】【F:app/config.py†L64-L76】
- Database URL validation executes at import time and raises if unset, crashing even non-DB CLI usage/tests; engine creation lacks TLS/async options and uses static pool sizes regardless of deployment topology.【F:app/database.py†L1-L28】
- Auth pipeline mixes strict and dev fallbacks: `verify_token` silently accepts DEV_MODE JWTs with weak shared secret and prints errors instead of structured logging/metrics; duplicate auth module (`app/auth.py`) bypasses signature verification entirely when DEV_MODE is set, risking production misconfiguration and inconsistent token handling across routers.【F:app/utils/security.py†L19-L150】【F:app/auth.py†L1-L126】
- Optional routers swallow import/registration failures and continue serving with partial functionality, giving only warnings; health root endpoints return static “healthy” responses without DB/engine checks, so readiness/liveness probes provide false positives.【F:app/main.py†L62-L236】
- CORS configuration is hardcoded to two localhost origins, ignoring environment overrides and lacking strict allowed methods/headers per route; no rate limiting, request size limits, or anti-abuse controls are applied across high-risk AI endpoints (chatbot, research, behavior AI).【F:app/main.py†L147-L191】【F:app/routers/chatbot.py†L1-L29】

## Recommendations
- Remove blanket warning suppression; configure structured logging with levels per logger and fail-fast on critical startup errors (DB schema creation, AI engine init, BAA compliance) with clear telemetry. Enforce BAA/ZDR/enterprise flags by gating AI routers or disabling initialization when noncompliant.【F:app/main.py†L4-L138】【F:app/config.py†L64-L76】
- Move DB URL validation into startup with actionable errors; support async engines when appropriate, enable SSL/TLS by default, and tune pool settings via environment to match deployment scale. Add health checks that actually hit the DB/engines.【F:app/database.py†L1-L28】【F:app/main.py†L221-L236】
- Consolidate authentication to one hardened path: require Cognito configuration in non-dev environments, remove signature skipping, adopt structured logging/metrics, rotate secrets, and add audience/issuer enforcement plus token revocation checks. Update route dependencies to use the unified verifier and add MFA/brute-force protections for login flows.【F:app/utils/security.py†L19-L150】【F:app/auth.py†L1-L126】
- Fail optional router imports loudly (or expose status endpoints) to avoid silent feature loss; add liveness/readiness endpoints that verify DB connectivity and AI engine initialization. Apply per-router CORS/rate limits, input validation, and payload size guards for AI-heavy endpoints to protect resources and PHI.【F:app/main.py†L62-L236】【F:app/routers/chatbot.py†L1-L29】
- Continue applying typed request/response models and patient/doctor access checks as in the medication side-effects router; extend the same defense-in-depth (role checks, audit logging, consent tracking) to all clinical/AI routes to ensure consistent privacy enforcement.【F:app/routers/medication_side_effects.py†L1-L195】
