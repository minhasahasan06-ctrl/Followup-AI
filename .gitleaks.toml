# =============================================================================
# Gitleaks Configuration - Followup AI
# =============================================================================
# This file configures gitleaks to ignore known false positives while
# maintaining strict secret detection for real credentials.
#
# IMPORTANT: Only add allowlist entries for verified false positives.
# Never allowlist real secrets - rotate them instead.
# =============================================================================

[extend]
useDefault = true

# =============================================================================
# Allowlist - Known False Positives
# =============================================================================
# These patterns are intentionally in the codebase for testing/documentation
# and do not represent actual secrets.
# =============================================================================

[[rules]]
id = "test-stripe-keys"
description = "Allow test Stripe keys in test files (sk_test_*, whsec_*)"
regex = '''(sk_test_[a-zA-Z0-9]{0,10}|whsec_[a-zA-Z0-9]{0,10})'''
allowlist = { paths = [
  '''tests/''',
  '''.*\.test\.(ts|tsx|js|jsx)$''',
  '''.*\.spec\.(ts|tsx|js|jsx)$'''
]}

[allowlist]
description = "Global allowlist for false positives"

# Test files that contain mock/fake secrets for testing
paths = [
  '''tests/python/test_payments\.py$''',
  '''tests/safe_logger\.test\.ts$''',
  '''tests/config_guard\.test\.ts$''',
  '''server/seed\.ts$''',
]

# Specific commits to ignore (if needed)
# commits = []

# =============================================================================
# Path-Scoped Allowlists for Documentation and Template Files
# =============================================================================
# These files contain example patterns for documentation purposes,
# not actual secrets. Each entry is scoped to a specific file/line.
# =============================================================================

# =============================================================================
# Path-Scoped Allowlists for Documentation and Template Files
# =============================================================================
# Each allowlist targets EXACT placeholder strings in specific files.
# Using precise patterns to avoid accidentally suppressing real secrets.
# =============================================================================

# .env.template - Exact placeholder strings (not real keys)
[[rules]]
id = "env-template-stripe-placeholders"
description = "Allow exact Stripe placeholder strings in env template"
regex = '''your-stripe-secret-key|your-webhook-secret|your-connect-client-id'''
allowlist = { paths = ['''cloud-run/\.env\.template$'''] }

# DEPLOYMENT.md - Exact placeholder text in documentation
[[rules]]
id = "deployment-docs-placeholders"
description = "Allow exact YOUR_ placeholder strings in deployment docs"
regex = '''YOUR_STRIPE_SECRET_KEY|YOUR_STRIPE_WEBHOOK_SECRET'''
allowlist = { paths = ['''cloud-run/DEPLOYMENT\.md$'''] }

# DEV_README.md - Exact truncated example patterns (ending in ...)
[[rules]]
id = "dev-readme-truncated-examples"
description = "Allow truncated example patterns (sk_test_..., sk-...) in dev docs"
regex = '''sk_test_\.{3}|sk-\.{3}'''
allowlist = { paths = ['''DEV_README\.md$'''] }

# Pre-commit hook - Pattern strings in SECRET_PATTERNS array for detection
[[rules]]
id = "pre-commit-detection-patterns"
description = "Allow secret detection patterns in pre-commit script SECRET_PATTERNS array"
regex = '''-----BEGIN PRIVATE KEY-----|-----BEGIN RSA PRIVATE KEY-----|-----BEGIN CERTIFICATE-----'''
allowlist = { paths = ['''scripts/pre-commit-hook\.sh$'''] }

# skin_analysis_service.py - False positive from variable naming pattern
# The code at line 359 is: slope_3day = covariance / variance
# Gitleaks may flag this due to variable naming patterns matching generic-api-key rule
[[rules]]
id = "skin-analysis-math-vars"
description = "Allow mathematical variable names in skin analysis perfusion calculations"
regex = '''slope_3day|rolling_24hr|perfusion'''
allowlist = { paths = ['''app/services/skin_analysis_service\.py$'''] }

# =============================================================================
# Custom Rules - Stricter Detection
# =============================================================================
# Additional rules to catch patterns that might be missed by defaults.
# =============================================================================

[[rules]]
id = "generic-api-key-header"
description = "Detect hardcoded API keys in headers"
regex = '''(?i)(x-api-key|api-key|apikey)\s*[:=]\s*['"][a-zA-Z0-9_-]{20,}['"]'''
secretGroup = 0
entropy = 3.5

[[rules]]
id = "hardcoded-jwt-secret"
description = "Detect hardcoded JWT secrets"
regex = '''(?i)(jwt[_-]?secret|signing[_-]?key)\s*[:=]\s*['"][a-zA-Z0-9_/-]{16,}['"]'''
secretGroup = 0
entropy = 3.0
