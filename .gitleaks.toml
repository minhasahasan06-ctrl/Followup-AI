# =============================================================================
# Gitleaks Configuration - Followup AI
# =============================================================================
# This file configures gitleaks to ignore known false positives while
# maintaining strict secret detection for real credentials.
#
# IMPORTANT: Only add allowlist entries for verified false positives.
# Never allowlist real secrets - rotate them instead.
# =============================================================================

[extend]
useDefault = true

# =============================================================================
# Allowlist - Known False Positives
# =============================================================================
# These patterns are intentionally in the codebase for testing/documentation
# and do not represent actual secrets.
# =============================================================================

[[rules]]
id = "test-stripe-keys"
description = "Allow test Stripe keys in test files (sk_test_*, whsec_*)"
regex = '''(sk_test_[a-zA-Z0-9]{0,10}|whsec_[a-zA-Z0-9]{0,10})'''
allowlist = { paths = [
  '''tests/''',
  '''.*\.test\.(ts|tsx|js|jsx)$''',
  '''.*\.spec\.(ts|tsx|js|jsx)$'''
]}

[allowlist]
description = "Global allowlist for false positives"

# Test files that contain mock/fake secrets for testing
paths = [
  '''tests/python/test_payments\.py$''',
  '''tests/safe_logger\.test\.ts$''',
  '''tests/config_guard\.test\.ts$''',
  '''server/seed\.ts$''',
]

# Specific commits to ignore (if needed)
# commits = []

# =============================================================================
# Path-Scoped Allowlists for Documentation and Template Files
# =============================================================================
# These files contain example patterns for documentation purposes,
# not actual secrets. Each entry is scoped to a specific file/line.
# =============================================================================

# .env.template - Contains placeholder values showing expected format
[[rules]]
id = "env-template-placeholders"
description = "Allow placeholder values in .env.template files"
regex = '''sk_live_your-stripe-secret-key|whsec_your-webhook-secret|ca_your-connect-client-id'''
allowlist = { paths = ['''cloud-run/\.env\.template$'''] }

# DEPLOYMENT.md - Documentation showing secret creation commands
[[rules]]
id = "deployment-docs-examples"
description = "Allow example commands in deployment documentation"
regex = '''YOUR_STRIPE_SECRET_KEY|YOUR_STRIPE_WEBHOOK_SECRET'''
allowlist = { paths = ['''cloud-run/DEPLOYMENT\.md$'''] }

# DEV_README.md - Documentation showing example key formats
[[rules]]
id = "dev-readme-examples"
description = "Allow example key formats in developer documentation"
regex = '''sk_test_\.\.\.|sk-\.\.\.'''
allowlist = { paths = ['''DEV_README\.md$'''] }

# CI workflow files - Pattern detection code, not actual secrets
[[rules]]
id = "ci-workflow-patterns"
description = "Allow pattern references in CI workflow files"
regex = '''RuleID|StartLine|gitleaks'''
allowlist = { paths = ['''\.github/workflows/ci_checks\.yml$'''] }

# Pre-commit hook - Regex patterns for secret detection
[[rules]]
id = "pre-commit-detection-patterns"
description = "Allow regex patterns in pre-commit hooks for detection"
regex = '''BEGIN (RSA |EC )?PRIVATE KEY|BEGIN CERTIFICATE|client_secret'''
allowlist = { paths = ['''scripts/pre-commit-hook\.sh$'''] }

# skin_analysis_service.py - False positive on variable names
[[rules]]
id = "skin-analysis-variables"
description = "Allow mathematical variable names in skin analysis service"
regex = '''slope_3day|covariance|variance'''
allowlist = { paths = ['''app/services/skin_analysis_service\.py$'''] }

# =============================================================================
# Custom Rules - Stricter Detection
# =============================================================================
# Additional rules to catch patterns that might be missed by defaults.
# =============================================================================

[[rules]]
id = "generic-api-key-header"
description = "Detect hardcoded API keys in headers"
regex = '''(?i)(x-api-key|api-key|apikey)\s*[:=]\s*['"][a-zA-Z0-9_-]{20,}['"]'''
secretGroup = 0
entropy = 3.5

[[rules]]
id = "hardcoded-jwt-secret"
description = "Detect hardcoded JWT secrets"
regex = '''(?i)(jwt[_-]?secret|signing[_-]?key)\s*[:=]\s*['"][a-zA-Z0-9_/-]{16,}['"]'''
secretGroup = 0
entropy = 3.0
